<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/p5.js/0.9.0/p5.min.js" integrity="sha256-WVsM3xrcqyuFNF3W1qtIKbHFsD0977nDQA8DCMp1zCw=" crossorigin="anonymous"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/p5.js/0.9.0/addons/p5.dom.min.js" integrity="sha256-2/3R3NV5zryj0fDjD3cDh+SNiWQ/TJiMVZzAo5FrhiU=" crossorigin="anonymous"></script>
    <title>Mood tracker</title>
</head>
<body>
    <h1>Welcome to the Mood tracker App</h1>
    <div><a href="/">enter</a> | <a href="all.html">list</a></div>

    <p>Latitude: <span id="latitude"></span>&deg;</p>
    <p>Longitude: <span id="longitude"></span>&deg;</p>
    <label for="mood">What is your mood?</label>
    <input id="mood" value="Pretty happy!" />
    <button id="geolocate">geolocate</button>
    <br><p></p>

    <script>
        // adding the P5.js name space (the setup() function)
        function setup(){
            noCanvas();
            // capture the default video camera
            const video = createCapture(VIDEO);
            video.size(320,240);

            document.getElementById('geolocate').addEventListener('click', event => {
            // test if geolocation is available
                if ("geolocation" in navigator) {
                    // geolocation is available
                    console.log("geolocation available");
                    const mood = document.getElementById('mood').value;
                    navigator.geolocation.getCurrentPosition(async position => {
                    const lat = position.coords.latitude;
                    const lon = position.coords.longitude;
                    // load the pixels of the video onto a canvas
                    video.loadPixels();
                    // taking the video's canvas and converting it to base64
                    const image64 = video.canvas.toDataURL();
                    
                    document.getElementById("latitude").textContent = lat;
                    document.getElementById("longitude").textContent = lon;


                    const data = {lat,lon,mood, image64};
                    const options ={
                            // declare the method fetch() will use
                        method : 'POST',
                        headers: {
                            // use the headers to explicit to the server the format of the post   
                            'Content-Type': 'application/json'},
                            // prepare the data to be sent as a JSON encoded string
                        body: JSON.stringify(data)
                    }; 
                    // the callback function of getCurrentPosition has been made async
                    // so the response from the server will not be handled too early
                    // i.e. will only be handled when the fetch() is completed
                    const response = await fetch('/api', options);
                    const json = await response.json();
                    console.log(json);
                    });
                } else {
                    // geolocation IS NOT available
                    console.log("geolocation not available");
                }
            });
        }
    </script>
</body>
</html>